
### タイムテーブル 🤔

### 今日話さないこと

- 株式会社FiNCについて
- We are hiring

### whoami

- @qsona
- 株式会社FiNC
- Microservices Meetup を主催しています
- Rails歴3年目に突入

### 宣伝

- 技術書典4 に参加します!
  - 2018/04/22 (日)

# はじめに

### マイクロサービスとは

"マイクロサービスは、 **協調して動作** する、小規模で **自律的** なサービスです。"

### マイクロサービスの目的

"マイクロサービスの最大の目標は「サービス化された機能のリリースサイクルを、その機能を管理するチームが独自に決定できるようにする」ことです。
それは何のためかというと「機能をどんどん改善して儲けたい」からです。"

事業会社におけるマイクロサービス化について - arclamp
http://arclamp.hatenablog.com/entry/2017/09/08/152005

### Railsとマイクロサービス

[意見] Railsにおいて、マイクロサービス化は早い方がいい

- 小〜中規模の開発に、Railsは威力を発揮する
- 大規模開発には向いていない部分がある
  - 動的型付けである
  - レイヤーが少ない
  - DIのような機能がない
- 大規模になるまえに、切り出していこう

### マイクロサービスは難しい？

- 全部やろうとすると難しい
  - いきなり完璧を目指すのは無理
- それぞれのフェーズでやるべきことを理解していれば、そこまで難しくないのでは？

### 本セッションの目的

マイクロサービスを進めていく上で、それぞれのフェーズにおいて何をするべきなのか？を理解する手がかりになること

### Maturity Modelとは

- 成熟度をレベル別に定義する
- 現在の状態を評価するものさし
- 「次に何を改善すべきか」を理解する手がかり

MaturityModel - Martin Fowler
https://martinfowler.com/bliki/MaturityModel.html

## マイクロサービス成熟度レベルを定義してみる

あとでまた出てくるので、さらっと流します。

### Lv.0

-  マイクロサービスを始めるのは時期尚早。

### Lv.1

- モノリシックRailsを効率的に開発できている。
- マイクロサービスを始めるための組織的な土壌がある。

### Lv.2

- マイクロサービスを始めている。3個くらい。
- その組織のビジネスドメインを理解し、適切にサービス分割できている。
- 分割されたサービスのドメインを中心に、協力できるチームまたはグループがある。
- 権限と責任の委譲が進められている。

### Lv.3

- マイクロサービスを増やしている。15個くらい。
- 様々な方法でサービスを連携している。
- サービス共通の関心事に対処している。
- チームの分割を進めている。
- 様々な自動化を進めている。

### Lv.4

- ビジネスに応じて、組織と技術が自然にスケールする。
- マイクロサービスの回復性(レジリエンス)を作れている。
  - サービス障害が連鎖しない状態
  - 結果として、全体の障害への耐久力が高い
- マイクロサービス由来の複雑さに対処できている。
- サービスはたくさんある。40個とか。

### Lv.5

- めっちゃすごい。どんどんスケールする。最高！！！！
- ∞個

### 個人的な課題感

- 巷にはLv.4やLv.5の話があふれている
  - もちろん参考になるし、それを目指したい
  - しかし、すぐに実践できるわけではない
- 基本的に今回はLv.3までの話をします

### この後の章構成

- 1.upto(3) do |n|
  - Lv.n の定義 (再掲)
  - Lv.n-1 => Lv.n に進むためにやること
    - 技術軸
    - 組織軸
  - このフェーズで実際にあった例
  - このフェーズにおすすめの参考文献
- end

# Lv.0 => Lv.1

## Lv.1の定義

### 成熟度の定義

- モノリシックRailsを効率的に開発できている。
- マイクロサービスを始めるための組織的な土壌がある。

## Lv.1に進むためにやること

### 概要

- 技術
  - 中規模のモノリシックRails開発でやるべきこと全て
- 組織
  - 職能を越えて協力できること

## [技術] 中規模のモノリシックRails開発でやるべきこと全て

### "中規模" Railsをちゃんと作れること

- MVCの責務を分割できる
- PORO (PlainなRubyクラス) を活用できる
- RESTfulを守れる
- 正規化したDB設計ができる
- 単体テストが書ける

### "大規模" Railsは作らない

- 以下のノウハウは要らない
  - Railsにレイヤードアーキテクチャを導入する
  - Trailblazer
  - その他、いろんなRails拡張
- シンプルに、Railsの思想に乗ろう

#### Simple is Best.
  
## [組織] 職能を越えて協力できること

#### 突然ですがつらいスライドです

### 職能を越えて協力していない例

- DevとOpsの分離
- CS対応へのエンジニアの温度感が低い
- 営業と技術者の対立
- 基盤開発チームと現場との溝
- クライアントチームとAPIチームの分離
- 品質管理チームへの丸投げ
- 研究開発がいつになってもユーザへの価値を産み出さない

### マイクロサービスの目的 (再掲)

"マイクロサービスの最大の目標は「サービス化された機能のリリースサイクルを、その機能を管理するチームが独自に決定できるようにする」ことです。
それは何のためかというと「機能をどんどん改善して儲けたい」からです。"

- これを達成するには、職能を越えた協力が不可欠

#### Change. Yes We Can! 💪

### コミュニケーションの重要性

https://twitter.com/yosuke_furukawa/status/976705435729248256

### コミュニケーションの重要性

- マイクロサービスにするだけでは、人や組織の問題は解決しない
- マイクロサービスとチームを1:1にするのは、初期段階では難しい
- 効果的なコミュニケーションが必要

### Lv.1 おすすめの文献

- アジャイルサムライ −達人開発者への道−
- レールの伸ばし方 by @willnet, Rails Developers Meetup 2017

# Lv.1 => Lv.2

## Lv.2の定義

### フェーズ

- マイクロサービスを始めている。3個くらい。

### 成熟度の定義

- その組織のビジネスドメインを理解し、適切にサービス分割できている。
- 分割されたサービスのドメインを中心に、協力できるチームまたはグループがある。
- 権限と責任の委譲が進められている。

## Lv.2に進むためにやること

### 概要

- 技術
  - ビジネス単位でのモジュール化
  - 良いAPI設計
  - APIの利用
- 組織
  - 技術者がオーナーシップを持つ


## [技術] ビジネス単位でのモジュール化

### 水平分割と垂直分割

- 水平分割 ... 技術的な境界面
  - 例: MVC, レイヤードアーキテクチャ
- 垂直分割 ... ビジネスの境界

### マイクロサービス=垂直分割

- マイクロサービスは垂直分割にすべき
  - 目的から考えても自然
  - ほぼ "定義" に近い
- このフェーズでは、水平分割でサービス化を **してはいけない**

### 正しい責務の分割

- 「高凝集」かつ「疎結合」になるようにする
  - 高凝集 ... 1つの変更のためには、1つのサービスだけ変更すればよい
  - 疎結合 ... あるサービスを変更しても、別のサービスを変更する必要がない
- マイクロサービスに限らず、モジュール化についての既存の考え方を持ち出せば良い
  - ドメイン駆動設計の「境界づけられたコンテキスト」

### どこからマイクロサービスに切り出すのか?

- 一言で表すと、「独立させて育てたいもの」
  - 変更の頻度が多い/多くしたい
  - 儲かる
  - 他の機能との結合度が低い

## [技術] API設計

### APIはマイクロサービスの命

- APIを通して連携することにより、サービスの自律性が生まれる
- Jeff Bezosの言葉
  - 全てのチームはサービスインターフェイスを通して機能を公開し、連携せよ
  - それ以外のプロセス間通信の方法(DB直読み, 共有メモリ, etc)は禁止である
  - これを守らない者は解雇だ

出典: The Secret to Amazons Success Internal APIs
https://apievangelist.com/2012/01/12/the-secret-to-amazons-success-internal-apis/

### Rails と API

- Rails, RESTfulの指針に乗っていくのが良い
- このテーマでは一度話しているので、今回は割愛します

参考: マイクロサービス指向 Rails API 開発ガイド (@qsona, ぎんざRuby会議01)
https://medium.com/finc-engineering/ginzaruby01-rails-api-guide-168fe9cf5b4d

## [技術] APIの利用

RailsでAPIを利用する側になるときのTips

### しばらくRuby/Railsの話をします

### APIクライアントの選定

- 生きてればなんでも良い
- Faraday がおすすめ
  - 複数のAPIを並列に叩く余地を残す
    - バックエンドにTyphoeusを利用
- cookpadの事例はおさえておこう

RESTful Web API 開発をささえる Garage - クックパッド開発者ブログ
http://techlife.cookpad.com/entry/2014/11/06/100000

### 新しい層を作る: Repository

- おすすめ: app/repositories
- app/models 以下は避ける
  - ネットワーク越しのアクセスは、DBアクセスとは全く別物
  - ActiveRecordと同じ雰囲気で呼び出せないほうがよい
  - (ActiveResourceは忘れよう)

### Repositoryクラスは目的ごとに分ける

- 呼び出すサービスごとではない
  - サービス名_repository.rb は避ける

### Hash を返さず、インスタンス/値を返す

- Hashを返すと、呼び出し側は使いにくい
- インスタンスにして返すまでがRepositoryの仕事
- 値 (数値や文字列) しか必要ないなら、それを返してよい

### レスポンスのうち、必要な値だけを利用する

- Tolerant Reader パターン
- 自サービスに必要な値だけをインスタンスにマップする

### だめな例

```rb
class User
  include ActiveModel::Model
  attr_accessor :id, :name, :age
end

class UserRepository
  def self.get(id)
    response = api_client.get("/v1/users/#{id}")
    return nil if response.status == 404
    raise 'Error' unless response.success?
    # response.body
    # => { 'id' => 1, 'name' => 'qsona', 'age' => 17 }
    User.new(response.body)
  end
end
```

### だめな理由

APIのレスポンスに新しく `gender` キーが追加されると?

```rb
# response.body
# => { 'id' => 1, 'name' => 'qsona', 'age' => 17, 'gender' => female }
User.new(response.body)
#=> ActiveModel::UnknownAttributeError: unknown attribute 'gender' for User.
```

### だめな理由

- APIへのキー追加は、後方互換性のある変更とみなされるべき
- したがって、キー追加でエラーになるのはNG

### 修正した例

```rb
# response.body
# => { 'id' => 1, 'name' => 'qsona', 'age' => 17 }
# User.new(response.body) # => ここを修正
body = response.body
User.new(id: body['id'], name: body['name'], age: body['age'])
```

### Repositoryのテスト

- Repository自体のテスト
  - 例: [bblimke/webmock](https://github.com/bblimke/webmock/) を利用する
  - これを書いておくと、繋ぎ込みの確度がぐっと上がる
- Repositoryを利用するコードのテスト
  - webmockではなく、Repositoryをmock/stubするのを推奨

## [組織] 技術者がオーナーシップを持つ

### マイクロサービスとオーナーシップ

- 最初は1チームで複数のサービスを管理してもよい
- 小さくても自律した「サービス」である
- **サービスのオーナー** を決めておいたほうがよい
  - 責任と権限の明確化
  - 技術者の成長につながるメリット

"マイクロサービスではそれぞれ独立したライフサイクルを持つ複数の自律的なコードベースがあります。多くの責任を引き受ける前に **個々のサービスを所有させることで開発者たちを向上させる** ことは、 **各自のキャリア目標を実現させるための優れた方法** であり、同時に責任者の負荷を軽減します。"

マイクロサービスアーキテクチャ 2.10 チームの構築

## 実例: "機械学習" マイクロサービス

### やったこと

- 「機械学習」のマイクロサービスを作った
- 様々な機械学習ロジックが、このサービスに実装されていった
  - アンケートの質問数を減らす
  - ユーザに表示するコンテンツのレコメンド
  - チャットボットの機能
- APIを通して、それらの機能を提供している

### 構成図

### 起こったこと(1) DB直読み

- 機械学習のロジックのためには、関係するデータがほぼまるごと必要
  - API連携では、読む方も作る方もつらい
- データを持つサービスがDBのリードレプリカを用意し、そこを機械学習サービスが直接叩くようにした
- 密結合のはじまり

### 起こったこと(2) ロジックの分散

- 機械学習をするためにも、元のビジネスのロジックはある程度必要
- ロジックが2サービスに分散
- 挙動を変更したい時に、2サービスの修正が必要
  - 凝集度の低下

### 結果

- 密結合・低凝集という、理想の逆を行く状態
- パフォーマンス問題を引き起こしがち
- 障害も起こりやすい

### なぜだめだったか

- ビジネスの単位ではないマイクロサービスを作ったこと
  - 「機械学習」そのものはビジネスではない
  - ビジネスの要請によって、機械学習という技術を使っている
  - 技術でサービス分割してしまった(水平分割)

### 教訓

- サービスの責務は、ビジネスで捉える
- 他サービスへのDBに直アクセスするのはいかなる場合でも禁止

### 機械学習サービスの近況

- 既存の "機械学習サービス" は、徐々に解体
  - 機械学習のスクリプトは、徐々に移行/削除
  - 作り直しもしている (次項)
- チャットボットは、メインのビジネスとして運用中
- 失敗は必ずある
  - 結果だけを見て言うのは簡単
  - つらいこともあるけどやっていき 💪

### 機械学習を新しくプロダクトに導入するときは

- 機械学習は、サービスの一部ととらえる
  - 機械学習単体でのマイクロサービス化は行わない
- 規模感・動作の重さにより、結合度を調整する
  - 小さい => Railsのサービスにスクリプトを同居
  - 大きい => サービスの子プロダクトとして独立
- サービスのエンジニアと機械学習のエンジニアが密に連携して、プロジェクトを進めている

### Lv.2 おすすめの文献

- わかる！ドメイン駆動設計 ～もちこちゃんの大冒険～ / TechBooster
- マイクロサービスアーキテクチャ
  - 1章, 3章, 4章 4.1〜4.7, 5章

# Lv.2 => Lv.3

## Lv.3の定義

### フェーズ

- マイクロサービスを増やしている。15個くらい。

### Lv.2からの変化

- サービスの増加にともない、様々な問題が起こり始める
- 組織面・技術面ともに「スケール」させることが課題

### 成熟度の定義

- チームの分割を進めている。
- 様々な方法でサービスを連携している。
- サービ
- 様々な自動化を進めている。

## Lv.3に進むためにやること

このフェーズは多岐に渡るため、技術面に話を絞ります。

### 概要

- API定義 / APIドキュメントの自動化
- 非同期イベント連携
- 社内ライブラリ
- インフラ面の様々な自動化
- マイクロサービス精神

## [技術] API定義 / APIドキュメントの自動化

### 実装への依存

- Lv.2では、他サービスの実装に依存していても問題は起きない
- Lv.3では複雑さが増し、辛くなってくる

### インターフェイス重視へ

- APIの型定義をかっちりする
- 型定義を利用して、レスポンスをバリデーションする
- 単体テストにも型定義を利用する

### 詳細

以下の資料で語り尽くされている

RubyKaigi 2017 でどんな発表をしたか
https://blog.onk.ninja/2017/09/21/my_talk_of_rubykaigi_2017

### マイクロサービスとしてのメリット

- サービス間が疎結合になり、自律性が増す
- サービスの再利用性が高くなる
- サービス連携におけるミスを減らせる
  - 各サービスの自律が、系を強くする

## 脱線して、テストの話

### E2Eテストは不要か?

- 誤解を恐れずに言えば... このフェーズでは「不要」
- 以下をきちんと行えば、繋ぎ込みはほぼ一発で完了する
  - API設計、サービス間連携の設計
  - (Provider) API型定義/ドキュメント生成/サービス単体のテスト
  - (Consumer) Repositoryのテスト
- E2Eテストにはデメリットが多い

### Consumer-Driven Contract Testing

- ConsumerとProviderがAPIに関する契約を結び、それをもとにProviderがテストする
- E2Eテストと違ってデメリットが少ないので、余力があればやっても良いと思う
- FiNCでは2年前から検討はしているが、今のところ優先度が高くない
- "型を守る" 以上の契約を結ぶのは実際難しそう

### 一つの事実

- FiNC社で2017年に起きた障害を振り返った結果、サービス間のE2E/CDCテストで防げたものはほとんどなかった
- E2Eテストを書いた上で、監視に利用していれば、早期発見できたケースはいくつかあった (セマンティック監視)
  - しかしそれも原因は、sidekiqやSQSのキューが詰まったなど
  - インフラレベルの監視で気づける
- 多いのはClient-Server間での疎通ミス
- サービス間は、単体テストでほとんどの問題を防げている

### 追記

- [Day 1 A-1] のセッションで、サービスを分割していく時のテストの話があったようです

安全かつ高速に進めるマイクロサービス化 / @k0kubun
https://speakerdeck.com/k0kubun/railsdm2018

## [技術] 非同期イベント連携

サービスの凝集度を保つために必要になります。弊社事例の発表があるので、詳細はそちらに譲ります。

## [技術] インフラ面の様々な自動化

FiNCではDocker, Amazon ECSを利用しています。今回は飛ばします。

## [技術] マイクロサービス精神

おもてなしの心

### 中央集中管理勢力

マイクロサービスの行く手を阻む敵

### 中央管理にしたくなる例

- 共通化 (DRY)
- 個人情報
  - セキュリティ
- デプロイスクリプト
- フロントエンド
  - UIの統一性

### 中央集中管理勢力との戦い

- 中央管理はマイクロサービス精神と相反する
- 中央管理したくなる理由は、様々なところに存在する
- それらの要件と、マイクロサービスを両立する努力をする

## 実例: 管理画面大統一構想

マイクロサービス城に現れた敵対勢力

### マイクロサービスと管理画面

- マイクロサービスにも管理画面は必要
  - 普通のサービスと同じ、ですよね
- マイクロサービスの数だけ管理画面ができる
- devise とかを使ってめいめいに実装する

### 課題

- アクセスコントロールが管理できていない
  - 各サービスが独自でアカウント管理
  - 退職者のアカウントを削除できていない
- 使う人が、どこに何があるのかわからなくなる
  - UXが統合されていない
  - 大量にブックマークすることに

### そこで管理画面大統一構想

- アクセスコントロールを集中管理
  - アカウント管理 (認証)
  - 誰が何をできるかの管理 (認可)

### 起こったこと

- ちっとも進まない

### 起こったこと

- そうこうしているうちに、新しい管理画面を作りたくなる
- 作ろうとしたら「これ以上管理画面を増やさないでくれ」と言われた

### 反論した

### 中央管理したい理由

- アクセスコントロール
  - 認証 (会社のActive Directoryアカウントを使いたい)
  - 認可
- UX (シームレスに遷移できる)

### アクセスコントロール (認証)

- Single Sign-onをする社内Gemを作った
  - ADを利用するため、ruby-saml をベース
  - Rails Engine
  - 社内ADの(秘匿ではない)情報をgem内に持たせ、導入を簡単に

### アクセスコントロール (認可)

- 認可はそもそも中央管理できない
  - 認可はビジネスロジック
  - 各サービスで実装すべきもの
- ユーザにタグを貼る機能だけ、社内Gemの中に作った
  - 簡易的なもの
  - (ここに認可のロジック等まで含めるとつらくなる)

### UXの統合

- 要求のレベルによってやり方が変わる
- まだやっていない
  - 社内管理画面なので要求レベルはいまのところ最低
- 次の例でも話します

### 例まとめ

- 中央管理は、マイクロサービスの思想に反する
- 中央管理したい理由はある
- 問題を見極め、適切に対処する

### 例まとめ

- 共通の関心事は、社内Gemで対処する
  - ビジネスのロジックは含めないこと
  - Gemに社内特有の情報まで含め、導入を簡単にする
  - (もちろん、社内特有のもの以外はOSSにしよう！)

## 実例: 複数種別のユーザに提供するサービスのマイクロサービス化

マイクロサービスはAPIだけにすべきか、Viewも提供すべきか？

### 法人向けサービス

- ユーザが2種類存在する
  - 従業員
  - 人事
- それぞれのユーザ向けに、アプリケーションがある

### 新規マイクロサービス

- ある新機能を作りたい
- 規模感を考えて、マイクロサービス化したい
- 従業員も人事も利用する

### APIモードにする?

- 2つ考えられる
- 1) APIだけを提供する
  - UIは既存の従業員/人事アプリケーションに実装
  - 既存アプリケーションからAPIを叩く
- 2) Viewも提供する
  - UIを何らかの方法で統合する

### メリット/デメリット 1) APIだけを提供する

- メリット: UIの統合が簡単
- デメリット: 実装が分散する
  - 機能実装のとき、3サービスに手をいれることになる

### メリット/デメリット 1) APIだけを提供する

- メリット: 実装が1サービスにまとまる(高凝集)
- デメリット: UIの統合が難しい
  - 1画面で複数サービスの機能を出す

### 今回は2を選択 (する予定)

- UIは、ある程度切り離されていても問題ない
  - 別のURLドメインで提供
  - Single Sign-onで体験をシームレスにする
- マイクロサービスのメリットを優先
  - 注: ユーザ体験より技術を優先している、というわけではない
  - シームレスなユーザ体験よりも、高速にPDCAを回して価値を提供していく方に重きをおいている

### UIの共通化

- UIのヘッダ部分などを、サービス間で共通化する必要がある
- やり方はいくつか考えられる
  - コピペ
  - ライブラリで共有
  - 1つのサービスが提供 (iframe)
- 検討中

### Lv.3 おすすめの文献

- マイクロサービスアーキテクチャ

# まとめ

## まとめです

- マイクロサービスに関連する話題は技術論・組織論など多岐にわたる
- 全ての能力を一朝一夕にして獲得することは不可能であり
- 各ステージによってどのような能力を獲得していくべきかを論じた
  - スモールスタートから徐々にやっていき 💪

## Microservicesは最高！！！！！！！！！！！！！！！！
