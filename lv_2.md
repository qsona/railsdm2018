
# Lv.1 => Lv.2

## Lv.2の定義

### フェーズ

- マイクロサービスを始めている。3個くらい。

### 成熟度の定義

- その組織のビジネスドメインを理解し、適切にサービス分割できている。
- 分割されたサービスのドメインを中心に、協力できるチームまたはグループがある。
- 権限と責任の委譲が進められている。

## Lv.2に進むためにやること

### 概要

- 技術
  - ビジネス単位でのモジュール化
  - 良いAPI設計
  - APIの利用
- 組織
  - 技術者がオーナーシップを持つ


## [技術] ビジネス単位でのモジュール化

### 水平分割と垂直分割

- 水平分割 ... 技術的な境界面
  - 例: MVC, レイヤードアーキテクチャ
- 垂直分割 ... ビジネスの境界

### マイクロサービス=垂直分割

- マイクロサービスは垂直分割にすべき
  - 目的から考えても自然
  - ほぼ "定義" に近い
- このフェーズでは、水平分割でサービス化を **してはいけない**

### 正しい責務の分割

- 「高凝集」かつ「疎結合」になるようにする
  - 高凝集 ... 1つの変更のためには、1つのサービスだけ変更すればよい
  - 疎結合 ... あるサービスを変更しても、別のサービスを変更する必要がない
- マイクロサービスに限らず、モジュール化についての既存の考え方を持ち出せば良い
  - ドメイン駆動設計の「境界づけられたコンテキスト」

### どこからマイクロサービスに切り出すのか?

- 一言で表すと、「独立させて育てたいもの」
  - 変更の頻度が多い/多くしたい
  - 儲かる
  - 他の機能との結合度が低い

## [技術] API設計

### APIはマイクロサービスの命

- APIを通して連携することにより、サービスの自律性が生まれる
- Jeff Bezosの言葉
  - 全てのチームはサービスインターフェイスを通して機能を公開し、連携せよ
  - それ以外のプロセス間通信の方法(DB直読み, 共有メモリ, etc)は禁止である
  - これを守らない者は解雇だ

出典: The Secret to Amazons Success Internal APIs
https://apievangelist.com/2012/01/12/the-secret-to-amazons-success-internal-apis/

### Rails と API

- Rails, RESTfulの指針に乗っていくのが良い
- このテーマでは一度話しているので、今回は割愛します

参考: マイクロサービス指向 Rails API 開発ガイド (@qsona, ぎんざRuby会議01)
https://medium.com/finc-engineering/ginzaruby01-rails-api-guide-168fe9cf5b4d

## [技術] APIの利用

RailsでAPIを利用する側になるときのTips

### しばらくRuby/Railsの話をします

### APIクライアントの選定

- 生きてればなんでも良い
- Faraday がおすすめ
  - 複数のAPIを並列に叩く余地を残す
    - バックエンドにTyphoeusを利用
- cookpadの事例はおさえておこう

RESTful Web API 開発をささえる Garage - クックパッド開発者ブログ
http://techlife.cookpad.com/entry/2014/11/06/100000

### 新しい層を作る: Repository

- おすすめ: app/repositories
- app/models 以下は避ける
  - ネットワーク越しのアクセスは、DBアクセスとは全く別物
  - ActiveRecordと同じ雰囲気で呼び出せないほうがよい
  - (ActiveResourceは忘れよう)

### Repositoryクラスは目的ごとに分ける

- 呼び出すサービスごとではない
  - サービス名_repository.rb は避ける

### Hash を返さず、インスタンス/値を返す

- Hashを返すと、呼び出し側は使いにくい
- インスタンスにして返すまでがRepositoryの仕事
- 値 (数値や文字列) しか必要ないなら、それを返してよい

### レスポンスのうち、必要な値だけを利用する

- Tolerant Reader パターン
- 自サービスに必要な値だけをインスタンスにマップする

### だめな例

```rb
class User
  include ActiveModel::Model
  attr_accessor :id, :name, :age
end

class UserRepository
  def self.get(id)
    response = api_client.get("/v1/users/#{id}")
    return nil if response.status == 404
    raise 'Error' unless response.success?
    # response.body
    # => { 'id' => 1, 'name' => 'qsona', 'age' => 17 }
    User.new(response.body)
  end
end
```

### だめな理由

APIのレスポンスに新しく `gender` キーが追加されると?

```rb
# response.body
# => { 'id' => 1, 'name' => 'qsona', 'age' => 17, 'gender' => female }
User.new(response.body)
#=> ActiveModel::UnknownAttributeError: unknown attribute 'gender' for User.
```

### だめな理由

- APIへのキー追加は、後方互換性のある変更とみなされるべき
- したがって、キー追加でエラーになるのはNG

### 修正した例

```rb
# response.body
# => { 'id' => 1, 'name' => 'qsona', 'age' => 17 }
# User.new(response.body) # => ここを修正
body = response.body
User.new(id: body['id'], name: body['name'], age: body['age'])
```

### Repositoryのテスト

- Repository自体のテスト
  - 例: [bblimke/webmock](https://github.com/bblimke/webmock/) を利用する
  - これを書いておくと、繋ぎ込みの確度がぐっと上がる
- Repositoryを利用するコードのテスト
  - webmockではなく、Repositoryをmock/stubするのを推奨

## [組織] 技術者がオーナーシップを持つ

### マイクロサービスとオーナーシップ

- 最初は1チームで複数のサービスを管理してもよい
- 小さくても自律した「サービス」である
- **サービスのオーナー** を決めておいたほうがよい
  - 責任と権限の明確化
  - 技術者の成長につながるメリット

"マイクロサービスではそれぞれ独立したライフサイクルを持つ複数の自律的なコードベースがあります。多くの責任を引き受ける前に **個々のサービスを所有させることで開発者たちを向上させる** ことは、 **各自のキャリア目標を実現させるための優れた方法** であり、同時に責任者の負荷を軽減します。"

マイクロサービスアーキテクチャ 2.10 チームの構築

## 実例: "機械学習" マイクロサービス

### やったこと

- 「機械学習」のマイクロサービスを作った
- 様々な機械学習ロジックが、このサービスに実装されていった
  - アンケートの質問数を減らす
  - ユーザに表示するコンテンツのレコメンド
  - チャットボットの機能
- APIを通して、それらの機能を提供している

### 構成図

### 起こったこと(1) DB直読み

- 機械学習のロジックのためには、関係するデータがほぼまるごと必要
  - API連携では、読む方も作る方もつらい
- データを持つサービスがDBのリードレプリカを用意し、そこを機械学習サービスが直接叩くようにした
- 密結合のはじまり

### 起こったこと(2) ロジックの分散

- 機械学習をするためにも、元のビジネスのロジックはある程度必要
- ロジックが2サービスに分散
- 挙動を変更したい時に、2サービスの修正が必要
  - 凝集度の低下

### 結果

- 密結合・低凝集という、理想の逆を行く状態
- パフォーマンス問題を引き起こしがち
- 障害も起こりやすい

### なぜだめだったか

- ビジネスの単位ではないマイクロサービスを作ったこと
  - 「機械学習」そのものはビジネスではない
  - ビジネスの要請によって、機械学習という技術を使っている
  - 技術でサービス分割してしまった(水平分割)

### 教訓

- サービスの責務は、ビジネスで捉える
- 他サービスへのDBに直アクセスするのはいかなる場合でも禁止

### 機械学習サービスの近況

- 既存の "機械学習サービス" は、徐々に解体
  - 機械学習のスクリプトは、徐々に移行/削除
  - 作り直しもしている (次項)
- チャットボットは、メインのビジネスとして運用中
- 失敗は必ずある
  - 結果だけを見て言うのは簡単
  - つらいこともあるけどやっていき 💪

### 機械学習を新しくプロダクトに導入するときは

- 機械学習は、サービスの一部ととらえる
  - 機械学習単体でのマイクロサービス化は行わない
- 規模感・動作の重さにより、結合度を調整する
  - 小さい => Railsのサービスにスクリプトを同居
  - 大きい => サービスの子プロダクトとして独立
- サービスのエンジニアと機械学習のエンジニアが密に連携して、プロジェクトを進めている

### Lv.2 おすすめの文献

- わかる！ドメイン駆動設計 ～もちこちゃんの大冒険～ / TechBooster
- マイクロサービスアーキテクチャ
  - 1章, 3章, 4章 4.1〜4.7, 5章
