# Lv.2 => Lv.3

## Lv.3の定義

### フェーズ

- マイクロサービスを増やしている。15個くらい。

### Lv.2からの変化

- サービスの増加にともない、様々な問題が起こり始める
- 組織面・技術面ともに「スケール」させることが課題

### 成熟度の定義

- チームの分割を進めている。
- 様々な方法でサービスを連携している。
- サービス共通の関心事に対処している。
- 様々な自動化を進めている。

## Lv.3に進むためにやること

このフェーズは多岐に渡るため、技術面に話を絞ります。

### 概要

- API定義 / APIドキュメントの自動化
- 非同期イベント連携
- 社内ライブラリ
- インフラ面の様々な自動化
- マイクロサービス精神

## [技術] API定義 / APIドキュメントの自動化

### 実装への依存

- Lv.2では、他サービスの実装に依存していても問題は起きない
- Lv.3では複雑さが増し、辛くなってくる

### インターフェイス重視へ

- APIの型定義をかっちりする
- 型定義を利用して、レスポンスをバリデーションする
- 単体テストにも型定義を利用する

### 詳細

以下の資料で語り尽くされている

RubyKaigi 2017 でどんな発表をしたか
https://blog.onk.ninja/2017/09/21/my_talk_of_rubykaigi_2017

### マイクロサービスとしてのメリット

- サービス間が疎結合になり、自律性が増す
- サービスの再利用性が高くなる
- サービス連携の失敗による障害を減らせる
  - 各サービスの自律が、系を強くする

## 脱線して、テストの話

### E2Eテストは不要か?

- 誤解を恐れずに言えば... このフェーズでは「不要」
- 以下をきちんと行えば、繋ぎ込みはほぼ一発で完了する
  - API設計、サービス間連携の設計
  - (Provider) API型定義/ドキュメント生成/サービス単体のテスト
  - (Consumer) Repositoryのテスト
- E2Eテストにはデメリットが多い

### Consumer-Driven Contract Testing

- ConsumerとProviderがAPIに関する契約を結び、それをもとにProviderがテストする
- E2Eテストと違ってデメリットが少ないので、余力があればやっても良いと思う
- FiNCでは2年前から検討はしているが、今のところ優先度が高くない
- "型を守る" 以上の契約を結ぶのは実際難しそう

### 一つの事実

- FiNC社で2017年に起きた障害を振り返った結果、サービス間のE2E/CDCテストで防げたものはほとんどなかった
- E2Eテストを書いた上で、監視に利用していれば、早期発見できたケースはいくつかあった (セマンティック監視)
  - しかしそれも原因は、sidekiqやSQSのキューが詰まったなど
  - インフラレベルの監視で気づける
- 多いのはClient-Server間での疎通ミス
- サービス間は、単体テストでほとんどの問題を防げている

## [技術] 非同期イベント連携

サービスの凝集度を保つために必要になります。弊社事例の発表があるので、詳細はそちらに譲ります。

## [技術] インフラ面の様々な自動化

FiNCではDocker, Amazon ECSを利用しています。今回は飛ばします。

## [技術] マイクロサービス精神

おもてなしの心

### 中央集中管理勢力

マイクロサービスの行く手を阻む敵

### 中央管理にしたくなる例

- 共通化 (DRY)
- 個人情報
  - セキュリティ
- デプロイスクリプト
- フロントエンド
  - UIの統一性

### 中央集中管理勢力との戦い

- 中央管理はマイクロサービス精神と相反する
- 中央管理したくなる理由は、様々なところに存在する
- それらの要件と、マイクロサービスを両立する努力をする

## 実例: 管理画面大統一構想

マイクロサービス城に現れた敵対勢力

## 実例: 複数種別のユーザに提供するサービスのマイクロサービス化

マイクロサービスはAPIだけにすべきか、Viewも提供すべきか？

### 様々な課題

このフェーズになると、拡大に伴う課題が出て来る

- コーディング規約が定まっていない
- 開発を始める際のドキュメントがない
- slackのチャンネルが多すぎる
- etc...

### 横断的な課題への対処


### Lv.3 おすすめの文献

- マイクロサービスアーキテクチャ
