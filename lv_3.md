
# Lv.2 => Lv.3

## Lv.3の定義

### フェーズ

- マイクロサービスを増やしている。15個くらい。

### Lv.2からの変化

- サービスの増加にともない、様々な問題が起こり始める
- 組織面・技術面ともに「スケール」させることが課題

### 成熟度の定義

- チームの分割を進めている。
- 様々な方法でサービスを連携している。
- サービス共通の関心事に対処している。
- チームの分割を進めている。
- 様々な自動化を進めている。

## Lv.3に進むためにやること

このフェーズは多岐に渡るため、技術面に話を絞ります。

### 概要

- API定義 / APIドキュメントの自動化
- 非同期イベント連携
- 社内ライブラリ
- インフラ面の様々な自動化
- マイクロサービス精神

## [技術] API定義 / APIドキュメントの自動化

### 実装への依存

- Lv.2では、他サービスの実装に依存していても問題は起きない
- Lv.3では複雑さが増し、辛くなってくる

### インターフェイス重視へ

- APIの型定義をかっちりする
- 型定義を利用して、レスポンスをバリデーションする
- 単体テストにも型定義を利用する

### 詳細

以下の資料で語り尽くされている

RubyKaigi 2017 でどんな発表をしたか
https://blog.onk.ninja/2017/09/21/my_talk_of_rubykaigi_2017

### API定義をかっちりすることのマイクロサービスとしてのメリット

- サービス間が疎結合になり、自律性が増す
- サービスの再利用性が高くなる
- サービス連携におけるミスを減らせる
  - 各サービスの自律が、系を強くする

## 脱線して、テストの話

### E2Eテストは不要か?

- 誤解を恐れずに言えば... このフェーズでは「不要」
- 以下をきちんと行えば、繋ぎ込みはほぼ一発で完了する
  - API設計、サービス間連携の設計
  - (Provider) API型定義/ドキュメント生成/サービス単体のテスト
  - (Consumer) Repositoryのテスト
- E2Eテストにはデメリットが多い

### Consumer-Driven Contract Testing

- ConsumerとProviderがAPIに関する契約を結び、それをもとにProviderがテストする
- E2Eテストと違ってデメリットが少ないので、余力があればやっても良いと思う
- FiNCでは2年前から検討はしているが、今のところ優先度が高くない
- "型を守る" 以上の契約を結ぶのは実際難しそう

### 一つの事実

- FiNC社で2017年に起きた障害を振り返った結果、サービス間のE2E/CDCテストで防げたものはほとんどなかった
- E2Eテストを書いた上で、監視に利用していれば、早期発見できたケースはいくつかあった (セマンティック監視)
  - しかしそれも原因は、sidekiqやSQSのキューが詰まったなど
  - インフラレベルの監視で気づける
- 多いのはClient-Server間での疎通ミス
- サービス間は、単体テストでほとんどの問題を防げている

### 追記

- [Day 1 A-1] のセッションで、サービスを分割していく時のテストの話があったようです

安全かつ高速に進めるマイクロサービス化 / @k0kubun
https://speakerdeck.com/k0kubun/railsdm2018

## [技術] 非同期イベント連携

サービスの凝集度を保つために必要になります。弊社事例の発表があるので、詳細はそちらに譲ります。

## [技術] インフラ面の様々な自動化

FiNCではDocker, Amazon ECSを利用しています。今回は飛ばします。

## [技術] マイクロサービス精神

おもてなしの心

### 中央集中管理勢力

マイクロサービスの行く手を阻む敵

### 中央管理にしたくなる例

- 共通化 (DRY)
- 個人情報
  - セキュリティ
- デプロイスクリプト
- フロントエンド
  - UIの統一性

### 中央集中管理勢力との戦い

- 中央管理はマイクロサービス精神と相反する
- 中央管理したくなる理由は、様々なところに存在する
- それらの要件と、マイクロサービスを両立する努力をする

## 実例: 管理画面大統一構想

マイクロサービス城に現れた敵対勢力

### マイクロサービスと管理画面

- マイクロサービスにも管理画面は必要
  - 普通のサービスと同じ、ですよね
- マイクロサービスの数だけ管理画面ができる
- devise とかを使ってめいめいに実装する

### 課題

- アクセスコントロールが管理できていない
  - 各サービスが独自でアカウント管理
  - 退職者のアカウントを削除できていない
- 使う人が、どこに何があるのかわからなくなる
  - UXが統合されていない
  - 大量にブックマークすることに

### そこで管理画面大統一構想

- アクセスコントロールを集中管理
  - アカウント管理 (認証)
  - 誰が何をできるかの管理 (認可)

### 起こったこと

- ちっとも進まない

### 起こったこと

- そうこうしているうちに、新しい管理画面を作りたくなる
- 作ろうとしたら「これ以上管理画面を増やさないでくれ」と言われた

### 反論した

### 中央管理したい理由

- アクセスコントロール
  - 認証 (会社のActive Directoryアカウントを使いたい)
  - 認可
- UX (シームレスに遷移できる)

### アクセスコントロール (認証)

- Single Sign-onをする社内Gemを作った
  - ADを利用するため、ruby-saml をベース
  - Rails Engine
  - 社内ADの(秘匿ではない)情報をgem内に持たせ、導入を簡単に

### アクセスコントロール (認可)

- 認可はそもそも中央管理できない
  - 認可はビジネスロジック
  - 各サービスで実装すべきもの
- ユーザにタグを貼る機能だけ、社内Gemの中に作った
  - 簡易的なもの
  - (ここに認可のロジック等まで含めるとつらくなる)

### UXの統合

- 要求のレベルによってやり方が変わる
- まだやっていない
  - 社内管理画面なので要求レベルはいまのところ最低
- 次の例でも話します

### 例まとめ

- 中央管理は、マイクロサービスの思想に反する
- 中央管理したい理由はある
- 問題を見極め、適切に対処する

### 例まとめ

- 共通の関心事は、社内Gemで対処する
  - ビジネスのロジックは含めないこと
  - Gemに社内特有の情報まで含め、導入を簡単にする
  - (もちろん、社内特有のもの以外はOSSにしよう！)

## 実例: 複数種別のユーザに提供するサービスのマイクロサービス化

マイクロサービスはAPIだけにすべきか、Viewも提供すべきか？

### 法人向けサービス

- ユーザが2種類存在する
  - 従業員
  - 人事
- それぞれのユーザ向けに、アプリケーションがある

### 新規マイクロサービス

- ある新機能を作りたい
- 規模感を考えて、マイクロサービス化したい
- 従業員も人事も利用する

### APIモードにする?

- 2つ考えられる
- 1) APIだけを提供する
  - UIは既存の従業員/人事アプリケーションに実装
  - 既存アプリケーションからAPIを叩く
- 2) Viewも提供する
  - UIを何らかの方法で統合する

### メリット/デメリット 1) APIだけを提供する

- メリット: UIの統合が簡単
- デメリット: 実装が分散する
  - 機能実装のとき、3サービスに手をいれることになる

### メリット/デメリット 1) APIだけを提供する

- メリット: 実装が1サービスにまとまる(高凝集)
- デメリット: UIの統合が難しい
  - 1画面で複数サービスの機能を出す

### 今回は2を選択 (する予定)

- UIは、ある程度切り離されていても問題ない
  - 別のURLドメインで提供
  - Single Sign-onで体験をシームレスにする
- マイクロサービスのメリットを優先
  - 注: ユーザ体験より技術を優先している、というわけではない
  - シームレスなユーザ体験よりも、高速にPDCAを回して価値を提供していく方に重きをおいている

### UIの共通化

- UIのヘッダ部分などを、サービス間で共通化する必要がある
- やり方はいくつか考えられる
  - コピペ
  - ライブラリで共有
  - 1つのサービスが提供 (iframe)
- 検討中

### Lv.3 おすすめの文献

- マイクロサービスアーキテクチャ
