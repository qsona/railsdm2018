# Lv.2 => Lv.3

## Lv.3の定義

### 定義

- マイクロサービスを増やしている。15個くらい。
- チームの分割を進めている。
- 様々な方法でサービスを連携している。
- サービス共通の関心事に対処している。
- 様々な自動化を進めている。

## Lv.3に進むためにやること

### 概要

- 組織
  - チームを分割していく
  - 共通の関心事に対処する
- 技術
  - API定義 / APIドキュメントの自動化
  - 非同期イベント連携
  - 社内ライブラリ
  - マイクロサービス精神

## [組織] チームを分割していく

## 実例(1) FiNC Appチームの分割

## [組織] 共通の関心事に対処する

### 様々な課題

このフェーズになると、拡大に伴う課題が出て来る

- コーディング規約が定まっていない
- 開発を始める際のドキュメントがない
- slackのチャンネルが多すぎる
- etc...

### 横断的な課題への対処



## [技術] API定義 / APIドキュメントの自動化

### API定義

- サービスが少ないうちは、他サービスの実装に依存しても問題は起きない
- サービスが増えてくると

### 2つのアプローチ

- APIの型定義をしっかりする
  - 型定義を利用して、レスポンスをバリデーションする
  - 単体テストにも型定義を利用する
  - インターフェイス重視
- 複数サービスをまたがるテストを書く
  - E2Eテスト
  - Consumer-Driven Contract テスト
  - 実装+テスト重視

### 個人的な見解

- 個人的には、インターフェイスを重視したい
  - マイクロサービスの自律性
  - チームを疎結合に

### E2Eテストは不要か?

- 誤解を恐れずに言えば、「不要」
- 以下をきちんと行えば、繋ぎ込みはほぼ一発で完了する
  - API設計、サービス間連携の設計
  - (Provider) API型定義/ドキュメント生成/単体テスト
  - (Consumer) Repositoryのテスト
- E2Eテストにはデメリットも多い
- 少数のクリティカルなシナリオに対して、効果的に行うのがよさそう

### Consumer-Driven Contract テストは?

- これも正直必要ないと思う
- "型を守る" 以上の契約を結ぶのは難しいのでは?
- 2年前から検討はしているが、今のところ優先度が高くない
- E2Eテストと違ってデメリットが少ないので、余力があればやっても良い

### 一つの真実

- FiNC社で2017年に起きた障害を振り返った結果、サービス間のE2E/CDCテストで防げたものはほとんどない
  - E2Eテストを書いた上で、監視に利用していれば、早期発見できたケースはいくつかあった
    - しかしそれも、sidekiqやSQSのキューが詰まったなどが原因
    - インフラレベルの監視で気づける
- サービス単体で自律するほうが重要
  - 単体テストでほとんどの問題を防げている

## 実例(2)

マイクロサービスの共同所有

## [技術] 非同期イベント連携

### 非同期イベント連携

- サービスの凝集度を保つために、必ず必要になる
- FiNC社

## [技術] マイクロサービス精神

おもてなしの心

### 中央集中管理勢力

マイクロサービスの行く手を阻む敵

中央管理にしたくなる理由の一例: セキュリティ

### 中央集中管理勢力との戦い

- 中央管理はマイクロサービス精神と相反する
- 中央管理したくなる理由は、様々なところに存在する
- それらの要件と、マイクロサービスを両立する努力をする

## 実例: 管理画面大統一構想

マイクロサービス城に現れた敵対勢力

## 実例: 複数種別のユーザに提供するサービスのマイクロサービス化

API mode?
